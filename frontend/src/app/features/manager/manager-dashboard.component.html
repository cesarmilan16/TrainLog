<section class="container manager" (click)="closeMenus(); closeSuggestionLists()">
  <header class="card topbar">
    <div>
      <span class="badge">Coach Mode</span>
      <h1>Centro de entrenamiento</h1>
      <p class="muted">Diseña bloques, organiza sesiones y ajusta el plan de cada atleta.</p>
      <div class="top-metrics">
        <span>{{ clients.length }} atletas</span>
        <span>{{ totalWorkouts }} bloques</span>
        <span>{{ exercises.length }} ejercicios visibles</span>
      </div>
    </div>
    <div class="topbar-actions">
      <button
        type="button"
        class="theme-toggle"
        [attr.aria-label]="isDarkMode ? 'Activar modo claro' : 'Activar modo oscuro'"
        [attr.title]="isDarkMode ? 'Activar modo claro' : 'Activar modo oscuro'"
        (click)="toggleTheme()"
      >
        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="2"></circle>
          <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
        </svg>
        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M21 12.8A9 9 0 1 1 11.2 3 7 7 0 0 0 21 12.8Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"></path>
        </svg>
        <span class="sr-only">{{ isDarkMode ? 'Modo claro' : 'Modo oscuro' }}</span>
      </button>
      <button type="button" class="ghost logout-btn" (click)="logout()">Cerrar sesión</button>
    </div>
  </header>

  @if (errorMessage) {
    <p class="error app-error">{{ errorMessage }}</p>
  }

  <section class="grid cols-3">
    <article class="card panel">
      <div class="section-title">
        <h2>Clientes</h2>
        <span class="muted">{{ clients.length }}</span>
      </div>

      @if (loadingClients) {
        <div class="list skeleton-list" aria-hidden="true">
          @for (row of [1, 2, 3, 4]; track row) {
            <div class="list-row">
              <div class="skeleton-item"></div>
              <div class="skeleton-dot"></div>
            </div>
          }
        </div>
      }

      @if (!loadingClients && clients.length === 0) {
        <p class="muted empty">No hay clientes todavía.</p>
      }

      @if (!loadingClients) {
        <div class="list">
          @for (client of clients; track client.id) {
            <div class="list-row" (click)="$event.stopPropagation()">
              <button
                class="list-item"
                [class.active]="selectedClientId === client.id"
                (click)="selectClient(client.id)"
              >
                <span class="title-row">
                  <span class="title">{{ client.name }}</span>
                  <span class="mini-chip">{{ client.workouts_count }} entrenamientos</span>
                </span>
                <small>{{ client.email }}</small>
              </button>

              <div class="menu-wrap">
                <button
                  type="button"
                  class="menu-trigger"
                  aria-label="Opciones cliente"
                  (click)="openClientMenu(client.id, $event)"
                >
                  ⋯
                </button>

                @if (openClientMenuId === client.id) {
                  <div class="menu-dropdown">
                    <button type="button" class="menu-item" (click)="openEditClientModal(client)">Editar</button>
                    <button type="button" class="menu-item danger" (click)="openDeleteClientConfirm(client.id)">Eliminar</button>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }

      <hr />

      <div class="create-section">
        <button type="button" class="ghost create-toggle" (click)="toggleCreateSection('client')">
          <span>Nuevo cliente</span>
          <strong>{{ showCreateClient ? '−' : '+' }}</strong>
        </button>

        @if (showCreateClient) {
          <form [formGroup]="createClientForm" (ngSubmit)="createClient()" class="form-row create-form">
            <div class="field">
              <input type="text" placeholder="Nombre" formControlName="name" />
              @if (createClientForm.controls.name.touched && createClientForm.controls.name.invalid) {
                <small class="field-error">El nombre es obligatorio</small>
              }
            </div>
            <div class="field">
              <input type="email" placeholder="Email" formControlName="email" />
              @if (createClientForm.controls.email.touched && createClientForm.controls.email.hasError('required')) {
                <small class="field-error">El email es obligatorio</small>
              }
              @if (createClientForm.controls.email.touched && createClientForm.controls.email.hasError('email')) {
                <small class="field-error">Formato de email inválido</small>
              }
            </div>
            <div class="field">
              <input type="password" placeholder="Password" formControlName="password" />
              @if (createClientForm.controls.password.touched && createClientForm.controls.password.hasError('required')) {
                <small class="field-error">La contraseña es obligatoria</small>
              }
              @if (createClientForm.controls.password.touched && createClientForm.controls.password.hasError('minlength')) {
                <small class="field-error">Mínimo 4 caracteres</small>
              }
            </div>
            <button type="submit">Crear cliente</button>
          </form>
        }
      </div>
    </article>

    <article class="card panel">
      <div class="section-title">
        <h2>Workouts</h2>
        <span class="muted">{{ workouts.length }}</span>
      </div>

      @if (!selectedClientId) {
        <p class="muted empty">Selecciona un cliente para ver sus workouts.</p>
      }

      @if (selectedClientId) {
        <div class="section-title section-title-sub">
          <h3>Mesociclos</h3>
          <span class="muted">{{ mesocycles.length }}</span>
        </div>

        @if (mesocycles.length === 0) {
          <p class="muted empty">Este cliente todavía no tiene mesociclos.</p>
        } @else {
          <div class="list mesocycle-list">
            @for (mesocycle of mesocycles; track mesocycle.id) {
              <div class="list-item">
                <span class="title-row">
                  <span class="title">{{ mesocycle.name }}</span>
                  <span class="mini-chip mini-chip-soft">{{ mesocycle.status }}</span>
                </span>
                <small>{{ mesocycle.startDate }} → {{ mesocycle.endDate }}</small>
                <small class="muted">{{ mesocycle.goal }}</small>
              </div>
            }
          </div>
        }

        <div class="create-section">
          <button type="button" class="ghost create-toggle" (click)="toggleCreateSection('mesocycle')">
            <span>Nuevo mesociclo</span>
            <strong>{{ showCreateMesocycle ? '−' : '+' }}</strong>
          </button>

          @if (showCreateMesocycle) {
            <form [formGroup]="createMesocycleForm" (ngSubmit)="createMesocycle()" class="form-row create-form">
              <div class="field">
                <input type="text" placeholder="Nombre del mesociclo" formControlName="name" />
                @if (createMesocycleForm.controls.name.touched && createMesocycleForm.controls.name.invalid) {
                  <small class="field-error">El nombre es obligatorio</small>
                }
              </div>
              <div class="field">
                <input type="text" placeholder="Objetivo (ej. Hipertrofia)" formControlName="goal" />
                @if (createMesocycleForm.controls.goal.touched && createMesocycleForm.controls.goal.invalid) {
                  <small class="field-error">El objetivo es obligatorio</small>
                }
              </div>
              <div class="mini-grid mini-grid-intensity">
                <div class="field">
                  <label for="new-mesocycle-start">Inicio</label>
                  <input id="new-mesocycle-start" type="date" formControlName="startDate" />
                  @if (createMesocycleForm.controls.startDate.touched && createMesocycleForm.controls.startDate.invalid) {
                    <small class="field-error">Fecha de inicio obligatoria</small>
                  }
                </div>
                <div class="field">
                  <label for="new-mesocycle-end">Fin</label>
                  <input id="new-mesocycle-end" type="date" formControlName="endDate" />
                  @if (createMesocycleForm.controls.endDate.touched && createMesocycleForm.controls.endDate.invalid) {
                    <small class="field-error">Fecha de fin obligatoria</small>
                  }
                </div>
              </div>
              <div class="field">
                <label for="new-mesocycle-status">Estado</label>
                <select id="new-mesocycle-status" formControlName="status">
                  <option value="PLANNED">Planificado</option>
                  <option value="ACTIVE">Activo</option>
                  <option value="COMPLETED">Completado</option>
                </select>
              </div>
              <button type="submit" [disabled]="!selectedClientId">Crear mesociclo</button>
            </form>
          }
        </div>

        <hr />

        <div class="workout-detail-shell">
          @if (loadingWorkouts) {
            <div class="loading-overlay muted">Cargando...</div>
          }

          <!-- Forzamos recreación del bloque al cambiar cliente para disparar :leave/:enter. -->
          @for (clientKey of [selectedClientId]; track clientKey) {
            <div class="list" @detailFadeSlide>
              @if (loadingWorkouts && workouts.length === 0) {
                <div class="list skeleton-list" aria-hidden="true">
                  @for (row of [1, 2, 3]; track row) {
                    <div class="skeleton-item"></div>
                  }
                </div>
              }

              @if (!loadingWorkouts && workouts.length === 0) {
                <p class="muted empty">Este cliente todavía no tiene workouts.</p>
              }

              @for (workout of workouts; track workout.id) {
                <div class="list-row" (click)="$event.stopPropagation()">
                  <button
                    class="list-item"
                    [class.active]="selectedWorkoutId === workout.id"
                    (click)="selectWorkout(workout.id)"
                  >
                    <span class="title-row">
                      <span class="title">{{ workout.name }}</span>
                      <span class="mini-chip mini-chip-soft">{{ workout.exercises_count ?? 0 }} ejercicios</span>
                    </span>
                  </button>

                  <div class="menu-wrap">
                    <button
                      type="button"
                      class="menu-trigger"
                      aria-label="Opciones entrenamiento"
                      (click)="openWorkoutMenu(workout.id, $event)"
                    >
                      ⋯
                    </button>

                    @if (openWorkoutMenuId === workout.id) {
                      <div class="menu-dropdown">
                        <button type="button" class="menu-item" (click)="openEditWorkoutModal(workout)">Editar</button>
                        <button type="button" class="menu-item danger" (click)="openDeleteWorkoutConfirm(workout.id)">Eliminar</button>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }

      <hr />

      <div class="create-section">
        <button type="button" class="ghost create-toggle" (click)="toggleCreateSection('workout')">
          <span>Nuevo workout</span>
          <strong>{{ showCreateWorkout ? '−' : '+' }}</strong>
        </button>

        @if (showCreateWorkout) {
          <form [formGroup]="createWorkoutForm" (ngSubmit)="createWorkout()" class="form-row create-form">
            <div class="field">
              <input type="text" placeholder="Nombre del workout" formControlName="name" />
              @if (createWorkoutForm.controls.name.touched && createWorkoutForm.controls.name.invalid) {
                <small class="field-error">El nombre es obligatorio</small>
              }
            </div>
            <button type="submit" [disabled]="!selectedClientId">Crear workout</button>
          </form>
        }
      </div>
    </article>

    <article class="card panel">
      <div class="section-title">
        <h2>Ejercicios</h2>
        <span class="muted">{{ exercises.length }}</span>
      </div>

      @if (!selectedWorkoutId) {
        <p class="muted empty">Selecciona un workout para ver sus ejercicios.</p>
      }

      @if (selectedWorkoutId && !loadingExercises && exercises.length === 0) {
        <p class="muted empty">Este workout no tiene ejercicios aún.</p>
      }

      @if (selectedWorkoutId) {
        <div class="exercise-detail-shell">
          @if (loadingExercises) {
            <div class="loading-overlay muted">Cargando...</div>
          }
          <!-- Forzamos recreación del bloque al cambiar entrenamiento para animación suave. -->
          @for (workoutKey of [selectedWorkoutId]; track workoutKey) {
            <div class="exercise-list" @detailFadeSlide>
              @if (loadingExercises && exercises.length === 0) {
                <div class="exercise-list skeleton-list" aria-hidden="true">
                  @for (row of [1, 2, 3]; track row) {
                    <div class="skeleton-item"></div>
                  }
                </div>
              }

              @for (exercise of exercises; track exercise.id) {
                <div class="exercise-item">
                  @if (editingExerciseId !== exercise.id) {
                    <div class="list-row" (click)="$event.stopPropagation()">
                      <div class="exercise-content">
                        <strong class="exercise-name">#{{ exercise.order_index }} {{ exercise.name }}</strong>
                        <p class="exercise-main">{{ exercise.sets }} series x {{ exercise.reps }} reps</p>
                        @if (exercise.rir !== null || exercise.rm_percent !== null) {
                          <p class="exercise-meta muted">
                            Intensidad:
                            @if (exercise.rir !== null) { RIR {{ exercise.rir }} }
                            @if (exercise.rir !== null && exercise.rm_percent !== null) { · }
                            @if (exercise.rm_percent !== null) { {{ exercise.rm_percent }}% RM }
                          </p>
                        }
                      </div>

                      <div class="menu-wrap">
                        <button
                          type="button"
                          class="menu-trigger"
                          aria-label="Opciones ejercicio"
                          (click)="openExerciseMenu(exercise.id, $event)"
                        >
                          ⋯
                        </button>

                        @if (openExerciseMenuId === exercise.id) {
                          <div class="menu-dropdown">
                            <button type="button" class="menu-item" (click)="startEdit(exercise)">Editar</button>
                            <button type="button" class="menu-item danger" (click)="deleteExercise(exercise.id)">Eliminar</button>
                          </div>
                        }
                      </div>
                    </div>
                  } @else {
                    <form [formGroup]="editExerciseForm" class="form-row compact">
                      <div class="field">
                        <label [for]="'edit-exercise-name-' + exercise.id">Nombre</label>
                        <div class="autocomplete">
                          <input
                            [id]="'edit-exercise-name-' + exercise.id"
                            type="text"
                            formControlName="name"
                            placeholder="Ej. Press banca"
                            (input)="onEditExerciseNameInput()"
                          />
                          @if (showEditSuggestions) {
                            <div class="suggestions-menu" (click)="$event.stopPropagation()">
                              @for (item of editExerciseSuggestions; track item.id) {
                                <button
                                  type="button"
                                  class="suggestion-item"
                                  (click)="selectSuggestion(item, 'edit')"
                                >
                                  {{ item.name }}
                                </button>
                              }
                            </div>
                          }
                        </div>
                        @if (editExerciseForm.controls.name.touched && editExerciseForm.controls.name.invalid) {
                          <small class="field-error">El nombre es obligatorio</small>
                        }
                      </div>
                      <div class="mini-grid mini-grid-main">
                        <div class="field">
                          <label [for]="'edit-exercise-sets-' + exercise.id">Series</label>
                          <input [id]="'edit-exercise-sets-' + exercise.id" type="number" formControlName="sets" placeholder="3" />
                          @if (editExerciseForm.controls.sets.touched && editExerciseForm.controls.sets.invalid) {
                            <small class="field-error">Series debe ser mayor que 0</small>
                          }
                        </div>
                        <div class="field">
                          <label [for]="'edit-exercise-reps-' + exercise.id">Repeticiones</label>
                          <input [id]="'edit-exercise-reps-' + exercise.id" type="number" formControlName="reps" placeholder="10" />
                          @if (editExerciseForm.controls.reps.touched && editExerciseForm.controls.reps.invalid) {
                            <small class="field-error">Repeticiones debe ser mayor que 0</small>
                          }
                        </div>
                        <div class="field">
                          <label [for]="'edit-exercise-order-' + exercise.id">Orden</label>
                          <input [id]="'edit-exercise-order-' + exercise.id" type="number" formControlName="order_index" placeholder="1" />
                          @if (editExerciseForm.controls.order_index.touched && editExerciseForm.controls.order_index.invalid) {
                            <small class="field-error">El orden debe ser mayor que 0</small>
                          }
                        </div>
                      </div>
                      <div class="mini-grid mini-grid-intensity">
                        <div class="field">
                          <label [for]="'edit-exercise-rir-' + exercise.id">RIR</label>
                          <input [id]="'edit-exercise-rir-' + exercise.id" type="number" formControlName="rir" placeholder="0-10" />
                          @if (editExerciseForm.controls.rir.touched && editExerciseForm.controls.rir.invalid) {
                            <small class="field-error">RIR debe estar entre 0 y 10</small>
                          }
                        </div>
                        <div class="field">
                          <label [for]="'edit-exercise-rm-' + exercise.id">Porcentaje RM</label>
                          <input [id]="'edit-exercise-rm-' + exercise.id" type="number" formControlName="rm_percent" placeholder="1-100" />
                          @if (editExerciseForm.controls.rm_percent.touched && editExerciseForm.controls.rm_percent.invalid) {
                            <small class="field-error">%RM debe estar entre 1 y 100</small>
                          }
                        </div>
                      </div>
                      <div class="row-actions">
                        <button type="button" class="action-btn action-btn--save" (click)="saveEdit(exercise.id)">Guardar</button>
                        <button type="button" class="action-btn action-btn--cancel" (click)="cancelEdit()">Cancelar</button>
                      </div>
                    </form>
                  }
                </div>
              }
            </div>
          }
        </div>
      }

      <hr />

      <div class="create-section">
        <button type="button" class="ghost create-toggle" (click)="toggleCreateSection('exercise')">
          <span>Nuevo ejercicio</span>
          <strong>{{ showCreateExercise ? '−' : '+' }}</strong>
        </button>

        @if (showCreateExercise) {
          <form [formGroup]="createExerciseForm" (ngSubmit)="createExercise()" class="form-row create-form">
            <div class="field">
              <label for="new-exercise-name">Nombre</label>
              <div class="autocomplete">
                <input
                  id="new-exercise-name"
                  type="text"
                  placeholder="Ej. Press banca"
                  formControlName="name"
                  (input)="onCreateExerciseNameInput()"
                />
                @if (showCreateSuggestions) {
                  <div class="suggestions-menu" (click)="$event.stopPropagation()">
                    @for (item of createExerciseSuggestions; track item.id) {
                      <button
                        type="button"
                        class="suggestion-item"
                        (click)="selectSuggestion(item, 'create')"
                      >
                        {{ item.name }}
                      </button>
                    }
                  </div>
                }
              </div>
              @if (createExerciseForm.controls.name.touched && createExerciseForm.controls.name.invalid) {
                <small class="field-error">El nombre es obligatorio</small>
              }
            </div>
            <div class="mini-grid mini-grid-main">
              <div class="field">
                <label for="new-exercise-sets">Series</label>
                <input id="new-exercise-sets" type="number" placeholder="3" formControlName="sets" />
                @if (createExerciseForm.controls.sets.touched && createExerciseForm.controls.sets.invalid) {
                  <small class="field-error">Series debe ser mayor que 0</small>
                }
              </div>
              <div class="field">
                <label for="new-exercise-reps">Repeticiones</label>
                <input id="new-exercise-reps" type="number" placeholder="10" formControlName="reps" />
                @if (createExerciseForm.controls.reps.touched && createExerciseForm.controls.reps.invalid) {
                  <small class="field-error">Repeticiones debe ser mayor que 0</small>
                }
              </div>
              <div class="field">
                <label for="new-exercise-order">Orden</label>
                <input id="new-exercise-order" type="number" placeholder="1" formControlName="order_index" />
                @if (createExerciseForm.controls.order_index.touched && createExerciseForm.controls.order_index.invalid) {
                  <small class="field-error">El orden debe ser mayor que 0</small>
                }
              </div>
            </div>
            <div class="mini-grid mini-grid-intensity">
              <div class="field">
                <label for="new-exercise-rir">RIR</label>
                <input id="new-exercise-rir" type="number" placeholder="0-10" formControlName="rir" />
                @if (createExerciseForm.controls.rir.touched && createExerciseForm.controls.rir.invalid) {
                  <small class="field-error">RIR debe estar entre 0 y 10</small>
                }
              </div>
              <div class="field">
                <label for="new-exercise-rm">Porcentaje RM</label>
                <input id="new-exercise-rm" type="number" placeholder="1-100" formControlName="rm_percent" />
                @if (createExerciseForm.controls.rm_percent.touched && createExerciseForm.controls.rm_percent.invalid) {
                  <small class="field-error">%RM debe estar entre 1 y 100</small>
                }
              </div>
            </div>
            <button type="submit" [disabled]="!selectedWorkoutId">Crear ejercicio</button>
          </form>
        }
      </div>
    </article>
  </section>

  @if (editModalOpen) {
    <div class="modal-backdrop" (click)="closeEditModal()">
      <div class="modal-card card" (click)="$event.stopPropagation()">
        <div class="modal-head">
          <h3>{{ editModalTitle }}</h3>
          <button type="button" class="ghost close-btn" (click)="closeEditModal()">✕</button>
        </div>

        <form [formGroup]="editEntityForm" class="form-row" (ngSubmit)="submitEditModal()">
          <div>
            <label for="edit-name">Nombre</label>
            <input id="edit-name" type="text" formControlName="name" placeholder="Nombre" />
            @if (editEntityForm.controls.name.touched && editEntityForm.controls.name.invalid) {
              <small class="field-error">El nombre es obligatorio</small>
            }
          </div>

          @if (editModalType === 'client') {
            <div>
              <label for="edit-email">Email</label>
              <input id="edit-email" type="email" formControlName="email" placeholder="Email" />
              @if (editEntityForm.controls.email.touched && editEntityForm.controls.email.hasError('email')) {
                <small class="field-error">Formato de email inválido</small>
              }
            </div>

            <div>
              <label for="edit-password">Password (opcional)</label>
              <input id="edit-password" type="password" formControlName="password" placeholder="Nueva contraseña" />
            </div>
          }

          <div class="row-actions">
            <button type="submit">Guardar cambios</button>
            <button type="button" class="ghost" (click)="closeEditModal()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  }

  @if (confirmModalOpen) {
    <div class="modal-backdrop" (click)="closeConfirmModal()">
      <div class="modal-card card" (click)="$event.stopPropagation()">
        <div class="modal-head">
          <h3>{{ confirmModalTitle }}</h3>
          <button type="button" class="ghost close-btn" (click)="closeConfirmModal()">✕</button>
        </div>

        <p class="muted">{{ confirmModalMessage }}</p>

        <div class="row-actions">
          <button type="button" class="danger" (click)="confirmDelete()">Eliminar</button>
          <button type="button" class="ghost" (click)="closeConfirmModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }
</section>
