<section class="container manager" (click)="closeMenus()">
  <header class="card topbar">
    <div>
      <span class="badge">Manager</span>
      <h1>Panel de gestión</h1>
      <p class="muted">Clientes, workouts y ejercicios en un flujo único.</p>
    </div>
    <button class="ghost" (click)="logout()">Cerrar sesión</button>
  </header>

  @if (errorMessage) {
    <p class="error app-error">{{ errorMessage }}</p>
  }

  <section class="grid cols-3">
    <article class="card panel">
      <div class="section-title">
        <h2>Clientes</h2>
        <span class="muted">{{ clients.length }}</span>
      </div>

      @if (loadingClients) {
        <p class="muted">Cargando...</p>
      }

      @if (!loadingClients && clients.length === 0) {
        <p class="muted empty">No hay clientes todavía.</p>
      }

      @if (!loadingClients) {
        <div class="list">
          @for (client of clients; track client.id) {
            <div class="list-row" (click)="$event.stopPropagation()">
              <button
                class="list-item"
                [class.active]="selectedClientId === client.id"
                (click)="selectClient(client.id)"
              >
                <span class="title">{{ client.name }}</span>
                <small>{{ client.email }}</small>
              </button>

              <div class="menu-wrap">
                <button
                  type="button"
                  class="menu-trigger"
                  aria-label="Opciones cliente"
                  (click)="openClientMenu(client.id, $event)"
                >
                  ⋯
                </button>

                @if (openClientMenuId === client.id) {
                  <div class="menu-dropdown">
                    <button type="button" class="menu-item" (click)="openEditClientModal(client)">Editar</button>
                    <button type="button" class="menu-item danger" (click)="openDeleteClientConfirm(client.id)">Eliminar</button>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }

      <hr />

      <h3>Nuevo cliente</h3>
      <form [formGroup]="createClientForm" (ngSubmit)="createClient()" class="form-row">
        <input type="text" placeholder="Nombre" formControlName="name" />
        <input type="email" placeholder="Email" formControlName="email" />
        <input type="password" placeholder="Password" formControlName="password" />
        <button type="submit">Crear cliente</button>
      </form>
    </article>

    <article class="card panel">
      <div class="section-title">
        <h2>Workouts</h2>
        <span class="muted">{{ workouts.length }}</span>
      </div>

      @if (!selectedClientId) {
        <p class="muted empty">Selecciona un cliente para ver sus workouts.</p>
      }

      @if (selectedClientId) {
        <div class="workout-detail-shell">
          @if (loadingWorkouts) {
            <div class="loading-overlay muted">Cargando...</div>
          }

          <!-- Forzamos recreación del bloque al cambiar cliente para disparar :leave/:enter. -->
          @for (clientKey of [selectedClientId]; track clientKey) {
            <div class="list" @detailFadeSlide>
              @if (!loadingWorkouts && workouts.length === 0) {
                <p class="muted empty">Este cliente todavía no tiene workouts.</p>
              }

              @for (workout of workouts; track workout.id) {
                <div class="list-row" (click)="$event.stopPropagation()">
                  <button
                    class="list-item"
                    [class.active]="selectedWorkoutId === workout.id"
                    (click)="selectWorkout(workout.id)"
                  >
                    <span class="title">{{ workout.name }}</span>
                  </button>

                  <div class="menu-wrap">
                    <button
                      type="button"
                      class="menu-trigger"
                      aria-label="Opciones entrenamiento"
                      (click)="openWorkoutMenu(workout.id, $event)"
                    >
                      ⋯
                    </button>

                    @if (openWorkoutMenuId === workout.id) {
                      <div class="menu-dropdown">
                        <button type="button" class="menu-item" (click)="openEditWorkoutModal(workout)">Editar</button>
                        <button type="button" class="menu-item danger" (click)="openDeleteWorkoutConfirm(workout.id)">Eliminar</button>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }

      <hr />

      <h3>Nuevo workout</h3>
      <form [formGroup]="createWorkoutForm" (ngSubmit)="createWorkout()" class="form-row">
        <input type="text" placeholder="Nombre del workout" formControlName="name" />
        <button type="submit" [disabled]="!selectedClientId">Crear workout</button>
      </form>
    </article>

    <article class="card panel">
      <div class="section-title">
        <h2>Ejercicios</h2>
        <span class="muted">{{ exercises.length }}</span>
      </div>

      @if (!selectedWorkoutId) {
        <p class="muted empty">Selecciona un workout para ver sus ejercicios.</p>
      }

      @if (selectedWorkoutId && !loadingExercises && exercises.length === 0) {
        <p class="muted empty">Este workout no tiene ejercicios aún.</p>
      }

      @if (selectedWorkoutId) {
        <div class="exercise-detail-shell">
          @if (loadingExercises) {
            <div class="loading-overlay muted">Cargando...</div>
          }
          <!-- Forzamos recreación del bloque al cambiar entrenamiento para animación suave. -->
          @for (workoutKey of [selectedWorkoutId]; track workoutKey) {
            <div class="exercise-list" @detailFadeSlide>
              @for (exercise of exercises; track exercise.id) {
                <div class="exercise-item">
                  @if (editingExerciseId !== exercise.id) {
                    <div class="list-row" (click)="$event.stopPropagation()">
                      <div>
                        <strong>#{{ exercise.order_index }} {{ exercise.name }}</strong>
                        <p class="muted">{{ exercise.sets }} series x {{ exercise.reps }} reps</p>
                        @if (exercise.rir !== null || exercise.rm_percent !== null) {
                          <p class="muted">
                            Intensidad:
                            @if (exercise.rir !== null) { RIR {{ exercise.rir }} }
                            @if (exercise.rir !== null && exercise.rm_percent !== null) { · }
                            @if (exercise.rm_percent !== null) { {{ exercise.rm_percent }}% RM }
                          </p>
                        }
                      </div>

                      <div class="menu-wrap">
                        <button
                          type="button"
                          class="menu-trigger"
                          aria-label="Opciones ejercicio"
                          (click)="openExerciseMenu(exercise.id, $event)"
                        >
                          ⋯
                        </button>

                        @if (openExerciseMenuId === exercise.id) {
                          <div class="menu-dropdown">
                            <button type="button" class="menu-item" (click)="startEdit(exercise)">Editar</button>
                            <button type="button" class="menu-item danger" (click)="deleteExercise(exercise.id)">Eliminar</button>
                          </div>
                        }
                      </div>
                    </div>
                  } @else {
                    <form [formGroup]="editExerciseForm" class="form-row compact">
                      <div class="field">
                        <label [for]="'edit-exercise-name-' + exercise.id">Nombre</label>
                        <input [id]="'edit-exercise-name-' + exercise.id" type="text" formControlName="name" placeholder="Ej. Press banca" />
                      </div>
                      <div class="mini-grid mini-grid-main">
                        <div class="field">
                          <label [for]="'edit-exercise-sets-' + exercise.id">Series</label>
                          <input [id]="'edit-exercise-sets-' + exercise.id" type="number" formControlName="sets" placeholder="3" />
                        </div>
                        <div class="field">
                          <label [for]="'edit-exercise-reps-' + exercise.id">Repeticiones</label>
                          <input [id]="'edit-exercise-reps-' + exercise.id" type="number" formControlName="reps" placeholder="10" />
                        </div>
                        <div class="field">
                          <label [for]="'edit-exercise-order-' + exercise.id">Orden</label>
                          <input [id]="'edit-exercise-order-' + exercise.id" type="number" formControlName="order_index" placeholder="1" />
                        </div>
                      </div>
                      <div class="mini-grid mini-grid-intensity">
                        <div class="field">
                          <label [for]="'edit-exercise-rir-' + exercise.id">RIR</label>
                          <input [id]="'edit-exercise-rir-' + exercise.id" type="number" formControlName="rir" placeholder="0-10" />
                        </div>
                        <div class="field">
                          <label [for]="'edit-exercise-rm-' + exercise.id">Porcentaje RM</label>
                          <input [id]="'edit-exercise-rm-' + exercise.id" type="number" formControlName="rm_percent" placeholder="1-100" />
                        </div>
                      </div>
                      <div class="row-actions">
                        <button type="button" class="action-btn action-btn--save" (click)="saveEdit(exercise.id)">Guardar</button>
                        <button type="button" class="action-btn action-btn--cancel" (click)="cancelEdit()">Cancelar</button>
                      </div>
                    </form>
                  }
                </div>
              }
            </div>
          }
        </div>
      }

      <hr />

      <h3>Nuevo ejercicio</h3>
      <form [formGroup]="createExerciseForm" (ngSubmit)="createExercise()" class="form-row">
        <div class="field">
          <label for="new-exercise-name">Nombre</label>
          <input id="new-exercise-name" type="text" placeholder="Ej. Press banca" formControlName="name" />
        </div>
        <div class="mini-grid mini-grid-main">
          <div class="field">
            <label for="new-exercise-sets">Series</label>
            <input id="new-exercise-sets" type="number" placeholder="3" formControlName="sets" />
          </div>
          <div class="field">
            <label for="new-exercise-reps">Repeticiones</label>
            <input id="new-exercise-reps" type="number" placeholder="10" formControlName="reps" />
          </div>
          <div class="field">
            <label for="new-exercise-order">Orden</label>
            <input id="new-exercise-order" type="number" placeholder="1" formControlName="order_index" />
          </div>
        </div>
        <div class="mini-grid mini-grid-intensity">
          <div class="field">
            <label for="new-exercise-rir">RIR</label>
            <input id="new-exercise-rir" type="number" placeholder="0-10" formControlName="rir" />
          </div>
          <div class="field">
            <label for="new-exercise-rm">Porcentaje RM</label>
            <input id="new-exercise-rm" type="number" placeholder="1-100" formControlName="rm_percent" />
          </div>
        </div>
        <button type="submit" [disabled]="!selectedWorkoutId">Crear ejercicio</button>
      </form>
    </article>
  </section>

  @if (editModalOpen) {
    <div class="modal-backdrop" (click)="closeEditModal()">
      <div class="modal-card card" (click)="$event.stopPropagation()">
        <div class="modal-head">
          <h3>{{ editModalTitle }}</h3>
          <button type="button" class="ghost close-btn" (click)="closeEditModal()">✕</button>
        </div>

        <form [formGroup]="editEntityForm" class="form-row" (ngSubmit)="submitEditModal()">
          <div>
            <label for="edit-name">Nombre</label>
            <input id="edit-name" type="text" formControlName="name" placeholder="Nombre" />
          </div>

          @if (editModalType === 'client') {
            <div>
              <label for="edit-email">Email</label>
              <input id="edit-email" type="email" formControlName="email" placeholder="Email" />
            </div>

            <div>
              <label for="edit-password">Password (opcional)</label>
              <input id="edit-password" type="password" formControlName="password" placeholder="Nueva contraseña" />
            </div>
          }

          <div class="row-actions">
            <button type="submit">Guardar cambios</button>
            <button type="button" class="ghost" (click)="closeEditModal()">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  }

  @if (confirmModalOpen) {
    <div class="modal-backdrop" (click)="closeConfirmModal()">
      <div class="modal-card card" (click)="$event.stopPropagation()">
        <div class="modal-head">
          <h3>{{ confirmModalTitle }}</h3>
          <button type="button" class="ghost close-btn" (click)="closeConfirmModal()">✕</button>
        </div>

        <p class="muted">{{ confirmModalMessage }}</p>

        <div class="row-actions">
          <button type="button" class="danger" (click)="confirmDelete()">Eliminar</button>
          <button type="button" class="ghost" (click)="closeConfirmModal()">Cancelar</button>
        </div>
      </div>
    </div>
  }
</section>
